---
sidebar_position: 2
title: 2. Comunica√ß√£o DDS com G1
description: Cyclone DDS, topics, QoS e network debugging
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# üì° Comunica√ß√£o DDS com Unitree G1

:::tip Objetivo do M√≥dulo
Dominar o Cyclone DDS usado pelo G1, entender os topics publicados/subscritos, configurar QoS para performance √≥tima, e debugar problemas de rede em tempo real.
:::

---

## üåê O Que √© DDS?

### Data Distribution Service Explained

**DDS (Data Distribution Service)** √© um middleware de comunica√ß√£o publish-subscribe usado para sistemas distribu√≠dos em tempo real. Pense nele como "MQTT para rob√≥tica cr√≠tica".

**Por que Unitree escolheu DDS?**
- ‚ö° **Lat√™ncia:** &lt; 1ms entre publisher e subscriber (mesma rede)
- üîÑ **Descoberta autom√°tica:** Nodes se encontram sem servidor central
- üì¶ **Type-safe:** Dados estruturados com IDL (Interface Definition Language)
- üõ°Ô∏è **QoS configur√°vel:** Confiabilidade vs performance trade-off
- üåê **Multicast:** Um publisher ‚Üí m√∫ltiplos subscribers eficientemente

**Compara√ß√£o com alternativas:**

| Feature | DDS (Cyclone) | ROS2 (usa DDS) | gRPC | WebSockets |
|---------|---------------|----------------|------|------------|
| **Lat√™ncia** | &lt; 1ms | 1-5ms | 5-20ms | 10-50ms |
| **Descoberta** | Autom√°tica | Autom√°tica | Manual (IP:port) | Manual |
| **Multicast** | ‚úÖ Sim | ‚úÖ Sim | ‚ùå N√£o | ‚ùå N√£o |
| **Realtime** | ‚úÖ Hard RT | üü° Soft RT | ‚ùå N√£o | ‚ùå N√£o |
| **Overhead** | Baixo (~100 bytes) | M√©dio (~200 bytes) | Alto (~1KB) | M√©dio |

---

## üèóÔ∏è Arquitetura DDS do G1

### Componentes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Seu Aplicativo Python/C++                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  unitree_sdk2_python (wrapper)                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Cyclone DDS (implementa√ß√£o do padr√£o DDS)          ‚îÇ
‚îÇ  - Publishers (envia dados)                         ‚îÇ
‚îÇ  - Subscribers (recebe dados)                       ‚îÇ
‚îÇ  - Topics (canais de comunica√ß√£o)                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Network Stack (UDP multicast)                      ‚îÇ
‚îÇ  - Interface: wlan0 ou eth0                         ‚îÇ
‚îÇ  - Porta: 7400-7450 (DDS padr√£o)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Fluxo de Dados

```
G1 Robot                           Your PC
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ  Topic: /state    ‚îÇ              ‚îÇ
‚îÇ  Publisher   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  Subscriber  ‚îÇ
‚îÇ  (100 Hz)    ‚îÇ   UDP Multicast   ‚îÇ  (callback)  ‚îÇ
‚îÇ              ‚îÇ                   ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ  Topic: /cmd      ‚îÇ              ‚îÇ
‚îÇ  Subscriber  ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  Publisher   ‚îÇ
‚îÇ  (executa)   ‚îÇ   UDP Unicast     ‚îÇ  (envia cmd) ‚îÇ
‚îÇ              ‚îÇ                   ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Descoberta autom√°tica:**
1. Ambos os lados enviam mensagens SPDP (Simple Participant Discovery Protocol)
2. Quando descobrem, trocam mensagens SEDP (Simple Endpoint Discovery Protocol)
3. Estabelecem conex√£o direta para cada topic matchado
4. Dados come√ßam a fluir sem interven√ß√£o manual

---

## üìã Topics do Unitree G1

### Topics Publicados pelo G1 (voc√™ subscreve)

<Tabs>
<TabItem value="state" label="üìä /robot_state">

**Descri√ß√£o:** Estado completo do rob√¥ (juntas, IMU, for√ßas, bateria)

**Frequ√™ncia:** 100 Hz (10ms)

**Tipo de dados:** `unitree_go.msg.dds_.RobotState_`

**Estrutura:**

```python
# Defini√ß√£o IDL (simplificada)
struct RobotState {
    # Header
    int64 timestamp;        # Unix epoch nanoseconds
    uint32 sequence_id;     # Incrementa a cada mensagem

    # Sistema
    float battery_voltage;
    float battery_percentage;
    float cpu_temperature;
    string control_mode;

    # Juntas (arrays de tamanho dof)
    sequence<float> joint_positions;      # [rad]
    sequence<float> joint_velocities;     # [rad/s]
    sequence<float> joint_torques;        # [Nm]
    sequence<float> joint_temperatures;   # [¬∞C]

    # IMU
    Quaternion imu_quaternion;
    Vector3 imu_angular_velocity;
    Vector3 imu_linear_acceleration;

    # For√ßas
    float left_foot_force_z;
    float right_foot_force_z;
    Vector3 left_foot_torque;
    Vector3 right_foot_torque;
};
```

**Exemplo de subscri√ß√£o:**

```python
from unitree_sdk2_python import Subscriber, RobotState

def state_callback(msg: RobotState):
    """Callback executado a cada mensagem (100 Hz)"""
    print(f"Bateria: {msg.battery_percentage:.1f}%")
    print(f"IMU Pitch: {msg.imu_euler[1] * 57.3:.1f}¬∞")

# Criar subscriber
sub = Subscriber(topic="/robot_state", msg_type=RobotState, callback=state_callback)
sub.spin()  # Bloqueia, processa callbacks
```

**QoS padr√£o:** RELIABLE, KEEP_LAST (depth=1)

</TabItem>
<TabItem value="camera" label="üì∑ /camera/color/image_raw">

**Descri√ß√£o:** Stream RGB da RealSense D435i

**Frequ√™ncia:** 30 Hz (pode configurar at√© 60 Hz)

**Tipo de dados:** `sensor_msgs.msg.Image`

**Resolu√ß√£o:** 1920x1080 (padr√£o) ou 640x480 (low-res)

**Estrutura:**

```python
struct Image {
    Header header;
    uint32 height;        # 1080
    uint32 width;         # 1920
    string encoding;      # "rgb8"
    uint8 is_bigendian;
    uint32 step;          # Row length in bytes
    sequence<uint8> data; # Pixel data (height * step bytes)
};
```

**Exemplo de subscri√ß√£o:**

```python
from unitree_sdk2_python import Subscriber
import numpy as np
import cv2

def camera_callback(msg):
    """Converte DDS Image para OpenCV Mat"""
    # Reshape flat array para matriz HxWx3
    img_np = np.frombuffer(msg.data, dtype=np.uint8).reshape(
        (msg.height, msg.width, 3)
    )

    # Converter RGB para BGR (OpenCV usa BGR)
    img_bgr = cv2.cvtColor(img_np, cv2.COLOR_RGB2BGR)

    # Processar imagem
    cv2.imshow("G1 Camera", img_bgr)
    cv2.waitKey(1)

sub = Subscriber("/camera/color/image_raw", callback=camera_callback)
```

**‚ö†Ô∏è Performance:** Stream de v√≠deo consome ~50 Mbps em 1080p. Use Ethernet ou reduza resolu√ß√£o para WiFi.

</TabItem>
<TabItem value="depth" label="üó∫Ô∏è /camera/depth/image_rect_raw">

**Descri√ß√£o:** Mapa de profundidade (stereo depth)

**Frequ√™ncia:** 30 Hz

**Tipo de dados:** `sensor_msgs.msg.Image`

**Resolu√ß√£o:** 1280x720

**Encoding:** `16UC1` (16-bit unsigned, 1 canal)

**Estrutura:**

```python
# Cada pixel √© dist√¢ncia em mm (0-10000)
# 0 = sem informa√ß√£o (muito perto/longe/oclus√£o)
```

**Exemplo de subscri√ß√£o:**

```python
def depth_callback(msg):
    # Converter para numpy array
    depth_np = np.frombuffer(msg.data, dtype=np.uint16).reshape(
        (msg.height, msg.width)
    )

    # Converter mm para metros
    depth_m = depth_np.astype(np.float32) / 1000.0

    # Filtrar valores inv√°lidos
    depth_m[depth_m == 0] = np.nan

    # Visualizar (normalizado para 0-255)
    depth_vis = cv2.normalize(depth_m, None, 0, 255, cv2.NORM_MINMAX, dtype=cv2.CV_8U)
    cv2.applyColorMap(depth_vis, cv2.COLORMAP_JET)
    cv2.imshow("Depth", depth_vis)

sub = Subscriber("/camera/depth/image_rect_raw", callback=depth_callback)
```

</TabItem>
<TabItem value="diagnostics" label="ü©∫ /diagnostics">

**Descri√ß√£o:** Status de sa√∫de do sistema

**Frequ√™ncia:** 1 Hz (slow)

**Tipo de dados:** `diagnostic_msgs.msg.DiagnosticArray`

**Conte√∫do:**

```python
struct DiagnosticArray {
    Header header;
    sequence<DiagnosticStatus> status;
};

struct DiagnosticStatus {
    byte level;        # OK=0, WARN=1, ERROR=2, STALE=3
    string name;       # "Motor:left_knee", "Battery", etc.
    string message;    # Descri√ß√£o leg√≠vel
    string hardware_id;
    sequence<KeyValue> values;  # M√©tricas adicionais
};
```

**Exemplo de subscri√ß√£o:**

```python
def diagnostics_callback(msg):
    for status in msg.status:
        level_str = ["OK", "WARN", "ERROR", "STALE"][status.level]
        print(f"[{level_str}] {status.name}: {status.message}")

        # Se erro, investigar valores
        if status.level >= 2:
            for kv in status.values:
                print(f"  {kv.key}: {kv.value}")

sub = Subscriber("/diagnostics", callback=diagnostics_callback)
```

**Uso:** Monitoramento de sa√∫de, alertas proativos, logging

</TabItem>
</Tabs>

---

### Topics que o G1 Subscreve (voc√™ publica)

<Tabs>
<TabItem value="joint_cmd" label="üéÆ /joint_command">

**Descri√ß√£o:** Comandos para juntas individuais

**Tipo de dados:** `unitree_go.msg.dds_.JointCommand_`

**Estrutura:**

```python
struct JointCommand {
    int64 timestamp;
    string joint_name;      # "left_knee", etc.

    # Modo POSITION
    float target_position;  # [rad]
    float max_velocity;     # [rad/s] limite
    float kp;               # Ganho proporcional (opcional)

    # Modo VELOCITY
    float target_velocity;  # [rad/s]

    # Modo TORQUE
    float target_torque;    # [Nm]
    float kd;               # Ganho derivativo (optional)

    # Geral
    string control_mode;    # "POSITION", "VELOCITY", "TORQUE"
};
```

**Exemplo de publica√ß√£o:**

```python
from unitree_sdk2_python import Publisher, JointCommand
import time

# Criar publisher
pub = Publisher(topic="/joint_command")

# Criar mensagem
cmd = JointCommand()
cmd.timestamp = int(time.time() * 1e9)  # Nanoseconds
cmd.joint_name = "left_knee"
cmd.control_mode = "POSITION"
cmd.target_position = 1.57  # 90 graus
cmd.max_velocity = 1.0      # M√°ximo 1 rad/s

# Publicar
pub.publish(cmd)
```

**QoS:** RELIABLE, KEEP_LAST (depth=10) - garante entrega

</TabItem>
<TabItem value="motion_cmd" label="üö∂ /motion_command">

**Descri√ß√£o:** Comandos de locomo√ß√£o de alto n√≠vel

**Tipo de dados:** `unitree_go.msg.dds_.MotionCommand_`

**Estrutura:**

```python
struct MotionCommand {
    int64 timestamp;

    # Velocidade desejada (body frame)
    float vx;      # [m/s] frente/tr√°s (-1.5 a 1.5)
    float vy;      # [m/s] lateral (-0.8 a 0.8)
    float vyaw;    # [rad/s] rota√ß√£o (-1.0 a 1.0)

    # Postura
    float body_height;  # [m] altura do torso (0.3 a 0.5)
    float body_pitch;   # [rad] inclina√ß√£o (-0.3 a 0.3)
    float body_roll;    # [rad] inclina√ß√£o lateral (-0.2 a 0.2)

    # Gait
    string gait_type;   # "walk", "trot", "stand"
    float step_height;  # [m] altura do passo (0.05 a 0.15)
};
```

**Exemplo de publica√ß√£o:**

```python
from unitree_sdk2_python import Publisher, MotionCommand

pub = Publisher(topic="/motion_command")

# Comando: andar para frente
cmd = MotionCommand()
cmd.timestamp = int(time.time() * 1e9)
cmd.vx = 0.5        # 0.5 m/s para frente
cmd.vy = 0.0
cmd.vyaw = 0.0
cmd.gait_type = "walk"
cmd.body_height = 0.4
cmd.step_height = 0.08

# Publicar continuamente (10 Hz m√≠nimo)
rate = 10  # Hz
while True:
    cmd.timestamp = int(time.time() * 1e9)
    pub.publish(cmd)
    time.sleep(1.0 / rate)
```

**‚ö†Ô∏è Importante:** Deve publicar continuamente! Se parar &gt; 500ms, G1 entra em IDLE.

</TabItem>
<TabItem value="emergency" label="üõë /emergency_stop">

**Descri√ß√£o:** Parada de emerg√™ncia

**Tipo de dados:** `std_msgs.msg.Bool`

**Estrutura:**

```python
struct Bool {
    bool data;  # true = STOP, false = RELEASE
};
```

**Exemplo:**

```python
from unitree_sdk2_python import Publisher
from std_msgs.msg import Bool

pub = Publisher(topic="/emergency_stop")

# Ativar emergency stop
msg = Bool()
msg.data = True
pub.publish(msg)

# Rob√¥ para imediatamente e entra em modo IDLE
# Para liberar:
msg.data = False
pub.publish(msg)
```

**Lat√™ncia t√≠pica:** &lt; 2ms (alta prioridade)

</TabItem>
</Tabs>

---

## ‚öôÔ∏è Configura√ß√£o do Cyclone DDS

### Arquivo de Configura√ß√£o XML

O Cyclone DDS √© configurado via arquivo XML. Localiza√ß√£o padr√£o: `/etc/cyclonedds/config.xml`

**Configura√ß√£o b√°sica (performance):**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CycloneDDS xmlns="https://cdds.io/config"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <Domain id="0">
        <General>
            <!-- Interface de rede (auto-detect ou espec√≠fica) -->
            <NetworkInterfaceAddress>auto</NetworkInterfaceAddress>

            <!-- Permitir multicast (descoberta autom√°tica) -->
            <AllowMulticast>true</AllowMulticast>

            <!-- Fragmenta√ß√£o para mensagens grandes (imagens) -->
            <FragmentSize>4096</FragmentSize>
        </General>

        <Internal>
            <!-- Thread scheduling (realtime) -->
            <Watermarks>
                <WhcHigh>500kB</WhcHigh>
            </Watermarks>
        </Internal>

        <Discovery>
            <!-- Descoberta de participantes -->
            <ParticipantIndex>auto</ParticipantIndex>

            <!-- Intervalo de heartbeats -->
            <SPDPInterval>1s</SPDPInterval>
        </Discovery>

        <Tracing>
            <!-- Logging (desabilitar em produ√ß√£o) -->
            <Verbosity>warning</Verbosity>
            <OutputFile>/tmp/cyclonedds.log</OutputFile>
        </Tracing>
    </Domain>
</CycloneDDS>
```

**Aplicar configura√ß√£o:**

<Tabs>
<TabItem value="env" label="üîß Via vari√°vel de ambiente">

```bash
# Tempor√°rio (apenas sess√£o atual)
export CYCLONEDDS_URI="file:///etc/cyclonedds/config.xml"

# Permanente (adicionar ao ~/.bashrc)
echo 'export CYCLONEDDS_URI="file:///etc/cyclonedds/config.xml"' >> ~/.bashrc
source ~/.bashrc
```

</TabItem>
<TabItem value="code" label="üíª Via c√≥digo Python">

```python
import os
os.environ['CYCLONEDDS_URI'] = 'file:///etc/cyclonedds/config.xml'

# Agora importar unitree_sdk2_python
from unitree_sdk2_python import G1Robot
```

</TabItem>
<TabItem value="inline" label="üìù Inline XML">

```python
import os

config_xml = """
<CycloneDDS>
    <Domain id="0">
        <General>
            <NetworkInterfaceAddress>wlan0</NetworkInterfaceAddress>
        </General>
    </Domain>
</CycloneDDS>
"""

os.environ['CYCLONEDDS_URI'] = f'data:,{config_xml}'

from unitree_sdk2_python import G1Robot
```

</TabItem>
</Tabs>

---

### Otimiza√ß√µes de Performance

<Tabs>
<TabItem value="low-latency" label="‚ö° Baixa Lat√™ncia">

**Cen√°rio:** Controle em tempo real (&lt; 1ms)

```xml
<CycloneDDS>
    <Domain id="0">
        <General>
            <NetworkInterfaceAddress>eth0</NetworkInterfaceAddress>
            <AllowMulticast>true</AllowMulticast>
            <FragmentSize>1472</FragmentSize> <!-- MTU ethernet - headers -->
        </General>

        <Internal>
            <!-- Processar pacotes imediatamente -->
            <DeliveryQueueMaxSamples>1</DeliveryQueueMaxSamples>

            <!-- Prioridade m√°xima para threads -->
            <SchedulingClass>Realtime</SchedulingClass>
            <SchedulingPriority>80</SchedulingPriority>
        </Internal>

        <Discovery>
            <SPDPInterval>100ms</SPDPInterval> <!-- Descoberta r√°pida -->
        </Discovery>
    </Domain>
</CycloneDDS>
```

**Requer:** Kernel RT-PREEMPT, permiss√µes CAP_SYS_NICE

```bash
# Instalar kernel realtime
sudo apt install linux-lowlatency

# Permitir scheduling RT
sudo setcap cap_sys_nice+ep $(which python3)
```

</TabItem>
<TabItem value="bandwidth" label="üìä Alta Largura de Banda">

**Cen√°rio:** Stream de v√≠deo, logs massivos

```xml
<CycloneDDS>
    <Domain id="0">
        <General>
            <NetworkInterfaceAddress>eth0</NetworkInterfaceAddress>
            <AllowMulticast>false</AllowMulticast> <!-- Unicast apenas -->
            <FragmentSize>8192</FragmentSize> <!-- Fragmentos maiores -->
        </General>

        <Internal>
            <!-- Buffers grandes -->
            <Watermarks>
                <WhcHigh>10MB</WhcHigh>
            </Watermarks>

            <!-- Batch de mensagens -->
            <MaxMessageSize>10MB</MaxMessageSize>
        </Internal>

        <Channels>
            <Channel name="video">
                <Transport>udp</Transport>
                <DiffServField>46</DiffServField> <!-- EF - Expedited Forwarding -->
            </Channel>
        </Channels>
    </Domain>
</CycloneDDS>
```

</TabItem>
<TabItem value="reliability" label="üõ°Ô∏è Confiabilidade M√°xima">

**Cen√°rio:** Comandos cr√≠ticos (n√£o pode perder)

```xml
<CycloneDDS>
    <Domain id="0">
        <General>
            <AllowMulticast>true</AllowMulticast>
            <FragmentSize>4096</FragmentSize>
        </General>

        <Internal>
            <!-- Retries agressivos -->
            <NackDelay>10ms</NackDelay>
            <RetransmitPeriod>100ms</RetransmitPeriod>

            <!-- History profundo -->
            <Watermarks>
                <WhcHigh>1MB</WhcHigh>
            </Watermarks>
        </Internal>

        <Reliability>
            <!-- Manter hist√≥rico longo -->
            <MaxHistoryDepth>100</MaxHistoryDepth>
        </Reliability>
    </Domain>
</CycloneDDS>
```

**QoS no c√≥digo:**

```python
from unitree_sdk2_python import Publisher, QoSProfile

qos = QoSProfile(
    reliability="RELIABLE",
    history="KEEP_ALL",  # N√£o descartar mensagens
    durability="TRANSIENT_LOCAL"  # Persistir durante sess√£o
)

pub = Publisher("/joint_command", qos=qos)
```

</TabItem>
</Tabs>

---

## üîç Network Debugging

### Ferramentas de Diagn√≥stico

<Tabs>
<TabItem value="ddsperf" label="üìä ddsperf (benchmark)">

**Instala√ß√£o:**

```bash
sudo apt install cyclonedds-tools
```

**Medir lat√™ncia:**

```bash
# Terminal 1: Subscriber (no seu PC)
ddsperf sub

# Terminal 2: Publisher (no G1 ou outro PC)
ddsperf pub -D 10  # 10 segundos

# Output:
# Latency (us): min=120, median=150, 99%=300, max=1200
```

**Medir throughput:**

```bash
# Publisher com payloads grandes
ddsperf pub -s 1MB -D 10

# Output:
# Throughput: 850 Mbps (average)
```

</TabItem>
<TabItem value="wireshark" label="ü¶à Wireshark">

**Filtros √∫teis:**

```
# Ver apenas tr√°fego DDS
udp.port >= 7400 && udp.port <= 7450

# Ver topic espec√≠fico
ddsi.topic == "robot_state"

# Ver apenas descoberta
ddsi.submessage_id == 0x09  # SPDP
```

**Identificar problemas:**
- ‚ùå **Pacotes duplicados:** QoS mal configurado
- ‚ùå **Fragmenta√ß√£o excessiva:** FragmentSize muito pequeno
- ‚ùå **Retransmiss√µes:** Perda de pacotes (WiFi ruim)

</TabItem>
<TabItem value="cyclonedds-cli" label="üîß cyclonedds CLI">

**Listar participantes:**

```bash
cyclonedds ls
```

**Output:**

```
Participants:
  - ID: 0x1a2b3c4d (192.168.123.10) [Unitree G1]
    Topics: /robot_state, /camera/color/image_raw, /diagnostics
  - ID: 0x5e6f7a8b (192.168.123.100) [Your PC]
    Topics: /joint_command, /motion_command
```

**Inspecionar topic:**

```bash
cyclonedds topic /robot_state
```

**Output:**

```
Topic: /robot_state
Type: unitree_go::msg::dds_::RobotState_
QoS:
  Reliability: RELIABLE
  History: KEEP_LAST (depth=1)
  Durability: VOLATILE
Publishers: 1 (G1)
Subscribers: 2 (your_app, logger)
```

**Monitorar mensagens:**

```bash
cyclonedds sub /robot_state
```

**Output (stream cont√≠nuo):**

```
[1234567890.123] RobotState:
  battery_percentage: 87.5
  joint_positions: [0.12, 0.04, -0.01, ...]
  ...
```

</TabItem>
<TabItem value="custom-tool" label="üõ†Ô∏è Custom Monitoring">

**Script Python para debug:**

```python
#!/usr/bin/env python3
"""
dds_monitor.py - Monitora sa√∫de da comunica√ß√£o DDS
"""

from unitree_sdk2_python import Subscriber, RobotState
import time
from collections import deque

class DDSMonitor:
    def __init__(self):
        self.msg_times = deque(maxlen=100)
        self.last_seq = -1
        self.lost_msgs = 0

    def callback(self, msg: RobotState):
        now = time.time()
        self.msg_times.append(now)

        # Detectar mensagens perdidas
        if self.last_seq != -1:
            expected_seq = (self.last_seq + 1) % (2**32)
            if msg.sequence_id != expected_seq:
                lost = (msg.sequence_id - expected_seq) % (2**32)
                self.lost_msgs += lost
                print(f"‚ö†Ô∏è  {lost} mensagens perdidas!")

        self.last_seq = msg.sequence_id

        # Calcular frequ√™ncia e jitter
        if len(self.msg_times) >= 2:
            intervals = [self.msg_times[i] - self.msg_times[i-1]
                        for i in range(1, len(self.msg_times))]
            freq = 1.0 / (sum(intervals) / len(intervals))
            jitter = max(intervals) - min(intervals)

            print(f"\rFreq: {freq:>6.1f} Hz | "
                  f"Jitter: {jitter*1000:>5.1f} ms | "
                  f"Lost: {self.lost_msgs:>4}",
                  end='', flush=True)

    def run(self):
        sub = Subscriber("/robot_state", callback=self.callback)
        print("üîç Monitorando /robot_state...")
        sub.spin()

if __name__ == "__main__":
    monitor = DDSMonitor()
    monitor.run()
```

**Executar:**

```bash
python3 dds_monitor.py
```

**Output:**

```
üîç Monitorando /robot_state...
Freq:  100.2 Hz | Jitter:   2.3 ms | Lost:    0
```

</TabItem>
</Tabs>

---

## üö® Troubleshooting Comum

### Problema 1: Participantes n√£o se descobrem

**Sintoma:**

```bash
cyclonedds ls
# Output: (vazio)
```

**Checklist:**

1. **Mesma rede?**
   ```bash
   ping 192.168.123.10
   # Deve responder
   ```

2. **Firewall bloqueando?**
   ```bash
   # Abrir portas DDS (7400-7450)
   sudo ufw allow 7400:7450/udp
   ```

3. **Interface correta?**
   ```bash
   # Verificar qual interface est√° ativa
   ip route get 192.168.123.10
   # Output: ... dev wlan0 ...

   # For√ßar interface no XML
   <NetworkInterfaceAddress>wlan0</NetworkInterfaceAddress>
   ```

4. **Multicast habilitado?**
   ```bash
   # Testar multicast
   iperf3 -c 239.255.0.1 -u -T 32 -t 5 -b 10M

   # Se falhar, desabilitar multicast
   <AllowMulticast>false</AllowMulticast>
   ```

---

### Problema 2: Lat√™ncia alta (&gt; 10ms)

**Diagn√≥stico:**

```bash
ddsperf pub -D 5 & ddsperf sub
```

**Se lat√™ncia &gt; 10ms:**

1. **WiFi congestionado?**
   ```bash
   # Verificar sinal
   iwconfig wlan0
   # Link Quality: 60/70 (bom), 30/70 (ruim)

   # Trocar para Ethernet ou canal WiFi menos congestionado
   ```

2. **CPU sobrecarregado?**
   ```bash
   top
   # Se python3 > 80% CPU, otimizar c√≥digo (menos callbacks)
   ```

3. **QoS mal configurado?**
   ```python
   # Usar BEST_EFFORT para lat√™ncia m√≠nima (aceit√°vel perder msgs)
   qos = QoSProfile(reliability="BEST_EFFORT")
   ```

---

### Problema 3: Mensagens perdidas

**Sintoma:** `dds_monitor.py` mostra `Lost: 150`

**Solu√ß√µes:**

1. **WiFi inst√°vel ‚Üí Ethernet**

2. **Buffer overflow:**
   ```xml
   <Watermarks>
       <WhcHigh>10MB</WhcHigh> <!-- Aumentar buffer -->
   </Watermarks>
   ```

3. **QoS RELIABLE:**
   ```python
   qos = QoSProfile(reliability="RELIABLE")
   pub = Publisher("/joint_command", qos=qos)
   ```

---

## üìà Exemplo Completo: Telemetria em Tempo Real

```python
#!/usr/bin/env python3
"""
telemetry.py - Sistema completo de telemetria DDS
Subscreve m√∫ltiplos topics e consolida dados
"""

from unitree_sdk2_python import Subscriber, RobotState
from dataclasses import dataclass, field
from typing import Dict
import time
import threading

@dataclass
class TelemetryData:
    """Dados consolidados de todos os topics"""
    timestamp: float = 0.0
    battery_voltage: float = 0.0
    battery_percentage: float = 0.0
    cpu_temperature: float = 0.0
    imu_pitch: float = 0.0
    imu_roll: float = 0.0
    left_foot_force: float = 0.0
    right_foot_force: float = 0.0
    joint_positions: Dict[str, float] = field(default_factory=dict)

class TelemetrySystem:
    def __init__(self):
        self.data = TelemetryData()
        self.lock = threading.Lock()

        # Subscribers
        self.state_sub = Subscriber("/robot_state", callback=self.state_callback)

        # Estat√≠sticas
        self.msg_count = 0
        self.start_time = time.time()

    def state_callback(self, msg: RobotState):
        """Processa mensagens de estado"""
        with self.lock:
            self.data.timestamp = time.time()
            self.data.battery_voltage = msg.battery_voltage
            self.data.battery_percentage = msg.battery_percentage
            self.data.cpu_temperature = msg.cpu_temperature
            self.data.imu_pitch = msg.imu_euler[1]
            self.data.imu_roll = msg.imu_euler[0]
            self.data.left_foot_force = msg.left_foot_force
            self.data.right_foot_force = msg.right_foot_force

            # Atualizar posi√ß√µes das juntas
            for name, pos in zip(msg.joint_names, msg.joint_positions):
                self.data.joint_positions[name] = pos

            self.msg_count += 1

    def get_data(self) -> TelemetryData:
        """Retorna c√≥pia thread-safe dos dados"""
        with self.lock:
            return self.data

    def get_statistics(self) -> Dict:
        """Retorna estat√≠sticas de comunica√ß√£o"""
        elapsed = time.time() - self.start_time
        freq = self.msg_count / elapsed if elapsed > 0 else 0

        return {
            "messages_received": self.msg_count,
            "uptime_seconds": elapsed,
            "average_frequency_hz": freq
        }

    def print_dashboard(self):
        """Imprime dashboard de telemetria"""
        while True:
            data = self.get_data()
            stats = self.get_statistics()

            # Clear screen (ANSI escape code)
            print("\033[2J\033[H")

            print("=" * 70)
            print(" " * 20 + "UNITREE G1 TELEMETRY")
            print("=" * 70)
            print()

            print(f"‚è±Ô∏è  Uptime: {stats['uptime_seconds']:.1f}s | "
                  f"Freq: {stats['average_frequency_hz']:.1f} Hz | "
                  f"Msgs: {stats['messages_received']}")
            print()

            print("üîã BATERIA")
            print(f"  Voltage:    {data.battery_voltage:>6.2f} V")
            print(f"  Percentage: {data.battery_percentage:>6.1f} %")
            print()

            print("üå°Ô∏è  TEMPERATURA")
            print(f"  CPU:        {data.cpu_temperature:>6.1f} ¬∞C")
            print()

            print("üß≠ ORIENTA√á√ÉO")
            print(f"  Pitch:      {data.imu_pitch * 57.3:>6.1f} ¬∞")
            print(f"  Roll:       {data.imu_roll * 57.3:>6.1f} ¬∞")
            print()

            print("üë£ FOR√áAS NOS P√âS")
            print(f"  Esquerdo:   {data.left_foot_force:>6.1f} N")
            print(f"  Direito:    {data.right_foot_force:>6.1f} N")
            print(f"  Total:      {data.left_foot_force + data.right_foot_force:>6.1f} N")
            print()

            print("ü¶ø JUNTAS (primeiras 6)")
            for i, (name, pos) in enumerate(list(data.joint_positions.items())[:6]):
                print(f"  {name:<20} {pos:>7.3f} rad  ({pos*57.3:>6.1f}¬∞)")

            print()
            print("=" * 70)

            time.sleep(0.1)  # 10 Hz

    def run(self):
        """Inicia sistema de telemetria"""
        # Thread para dashboard
        dashboard_thread = threading.Thread(target=self.print_dashboard, daemon=True)
        dashboard_thread.start()

        # Thread principal processa callbacks
        print("üöÄ Sistema de telemetria iniciado...")
        self.state_sub.spin()

if __name__ == "__main__":
    telemetry = TelemetrySystem()
    try:
        telemetry.run()
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Telemetria interrompida")
```

**Executar:**

```bash
python3 telemetry.py
```

---

## ‚úÖ Checklist de Conclus√£o

- [ ] Entendi o que √© DDS e por que √© usado no G1
- [ ] Conhe√ßo todos os topics principais (/robot_state, /joint_command, etc.)
- [ ] Configurei Cyclone DDS via XML
- [ ] Testei ddsperf (lat√™ncia &lt; 5ms)
- [ ] Criei subscriber para /robot_state
- [ ] Criei publisher para /joint_command
- [ ] Executei telemetry.py com sucesso
- [ ] Debuguei comunica√ß√£o com cyclonedds CLI ou Wireshark

---

## üîó Pr√≥ximos Passos

:::tip Pr√≥ximo M√≥dulo
**[‚ö° Controle de Baixo N√≠vel ‚Üí](./controle-baixo-nivel)**

Aprenda controle direto de motores: torque mode, position mode, PID tuning e safety limits.
:::

**Recursos adicionais:**
- [Cyclone DDS Docs](https://github.com/eclipse-cyclonedds/cyclonedds)
- [DDS Specification](https://www.omg.org/spec/DDS/)
- [Unitree DDS Topics Reference](https://support.unitree.com/home/en/developer/topics)

---

**‚è±Ô∏è Tempo estimado:** 60-80 min
**üß† N√≠vel:** Intermedi√°rio-Avan√ßado
**üíª Hands-on:** 70% pr√°tico, 30% te√≥rico
